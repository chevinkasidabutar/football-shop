{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>BolaBale Store</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="bg-floating-blobs w-full pt-20 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    {# ===================== HERO / SEARCH / MOST POPULAR ===================== #}
    <section id="home" class="mb-12">
      <!-- Welcome -->
      <div class="flex items-start justify-between gap-4 mb-6">
        <div>
          <h1 class="text-3xl font-bold text-gray-900 mb-1">
            Welcome, <span class="text-purple-600">{{ user.username }}</span>!
          </h1>
          <p class="text-gray-600">Your next winning goal starts with the perfect gear</p>
        </div>
        <div class="hidden sm:block text-sm text-gray-500">Last login: {{ last_login }}</div>
      </div>

      <!-- Search (AJAX) -->
      <form id="searchForm" method="get" action="" class="mb-6">
        <div class="glass rounded-2xl border border-purple-100 p-3 shadow-card flex items-center gap-3">
          <svg class="w-5 h-5 text-purple-500" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21 21l-4.3-4.3m1.8-5.2a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <input id="qInput" type="text" name="q" value="{{ query }}" placeholder="Search products..."
                 class="w-full bg-transparent focus:outline-none placeholder-gray-400">
          <button class="px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700">
            Search
          </button>
        </div>
      </form>

      <!-- Hero Card -->
      <div class="rounded-2xl overflow-hidden shadow-card mb-8"
           style="background:linear-gradient(135deg,#f5e8ff,#dbeafe 55%,#ffd1e6);">
        <div class="p-6 sm:p-8 flex flex-col sm:flex-row items-center gap-6">
          <div class="flex-1">
            <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900 mb-2">The Beautiful Game, Perfected</h2>
            <p class="text-gray-700 mb-4">Find your matchday edge here.</p>
            <a href="#all" class="px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700">Explore All Products →</a>
          </div>
          <img src="{% static 'image/no-name.JPG' %}" class="w-40 h-40 object-cover rounded-xl ring-4 ring-white/60 shadow-md" alt="promo">
        </div>
      </div>

      <!-- Most Popular -->
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-xl font-bold text-gray-900">Most Popular</h3>
        <a href="?filter=all" class="text-sm text-purple-600 hover:underline">See all</a>
      </div>

      {% if popular_list %}
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
          {% for product in popular_list %}
            {% include 'card_product.html' with product=product %}
          {% endfor %}
        </div>
      {% else %}
        <div class="glass rounded-2xl border border-purple-100 p-6 shadow-card text-gray-600">
          No popular products yet.
        </div>
      {% endif %}
    </section>

    {# ===================== ALL PRODUCTS (AJAX) ===================== #}
    <section id="all">
      <div class="mb-6 flex items-center justify-between gap-3 flex-wrap">
        <h3 class="text-xl font-bold text-gray-900">
          {% if query %}Search Results{% elif filter_type == 'my' %}My Products{% elif selected_category %}Category: {{ selected_category }}{% else %}All Products{% endif %}
        </h3>
        <div class="flex items-center gap-2">
          <button id="btnRefresh" class="px-3 py-2 rounded-lg border font-medium hover:bg-gray-50">↻ Refresh</button>
          {% if user.is_authenticated %}
            <button id="btnOpenCreate" class="px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700">
              + Create Product
            </button>
          {% endif %}
        </div>
      </div>

      <!-- Loading / Error / Empty States -->
      <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
        <svg class="animate-spin h-8 w-8 text-purple-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <p class="text-gray-600 mt-3">Loading products...</p>
      </div>
      <div id="error" class="hidden text-center text-red-600 font-semibold p-4"></div>
      <div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
        <img src="{% static 'image/no-name.JPG' %}" alt="No product" class="w-32 h-32 mx-auto mb-5 object-contain">
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No Products yet</h3>
        <p class="text-gray-500 mb-6">Be the first to add a product to the shop.</p>
        {% if user.is_authenticated %}
          <button id="btnOpenCreateEmpty" class="px-5 py-3 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700">
            Create Product
          </button>
        {% else %}
          <a href="{% url 'main:login_user' %}" class="px-5 py-3 rounded-lg bg-gray-900 text-white font-semibold hover:opacity-90">
            Login to Create
          </a>
        {% endif %}
      </div>

      <!-- Products Grid (AJAX render) -->
      <div id="grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5"></div>
    </section>
  </div>
</div>

{# ===================== MODAL CREATE/EDIT PRODUCT ===================== #}
<div id="crudModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div id="crudModalContent" class="bg-white rounded-lg shadow-lg w-5/6 sm:w-3/5 md:w-1/2 lg:w-2/5 xl:w-1/3 max-h-screen overflow-y-auto">
    <div class="flex items-center justify-between p-4 border-b">
      <div>
        <h3 class="text-xl font-semibold text-gray-900">Create Product</h3>
        <p class="text-sm text-gray-600 mt-1">Add a new product to your shop</p>
      </div>
      <button type="button" class="text-gray-400 hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="hideModal()">✕</button>
    </div>
    <div class="px-6 py-4 space-y-6 form-style">
      <form id="productForm">
        {% csrf_token %}
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Product Name</label>
          <input type="text" id="name" name="name" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Description</label>
          <textarea id="description" name="description" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Category</label>
          <input type="text" id="category" name="category" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Price</label>
          <input type="number" id="price" name="price" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Size</label>
          <input type="text" id="size" name="size" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Colors</label>
          <input type="text" id="color" name="color" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Thumbnail URL</label>
          <input type="url" id="thumbnail" name="thumbnail" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
        </div>
        <div class="mb-4 flex items-center">
          <input type="checkbox" id="is_featured" name="is_featured" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded">
          <label for="is_featured" class="ml-2 text-sm font-medium text-gray-900">Featured Product</label>
        </div>
      </form>
    </div>
    <div class="flex flex-col sm:flex-row gap-4 p-6 border-t border-gray-200 rounded-b">
      <button type="button" class="order-2 sm:order-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50" onclick="hideModal()">Cancel</button>
      <button type="submit" id="submitProduct" form="productForm" class="order-1 sm:order-2 flex-1 bg-purple-600 text-white px-6 py-3 rounded-md font-medium hover:bg-purple-700">Publish Product</button>
    </div>
  </div>
</div>

<!-- ===================== MODAL CONFIRM DELETE ===================== -->
<div id="deleteModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800/50">
  <div class="bg-white rounded-lg shadow-lg w-11/12 sm:w-[420px]">
    <div class="p-4 border-b">
      <h3 class="text-lg font-semibold">Hapus Produk</h3>
      <p class="text-sm text-gray-600 mt-1">Apakah kamu yakin ingin menghapus produk ini? Tindakan ini tidak bisa dibatalkan.</p>
    </div>
    <div class="p-4 flex gap-3 justify-end">
      <button type="button" id="btnCancelDelete" class="px-4 py-2 rounded-md border">Batal</button>
      <button type="button" id="btnConfirmDelete" class="px-4 py-2 rounded-md bg-red-600 text-white">Hapus</button>
    </div>
  </div>
</div>

{# ===================== SCRIPTS (AJAX + TOAST) ===================== #}
<script>
/* ========= Static asset (1x) ========= */
const NO_IMAGE_URL = "{% static 'image/no-name.JPG' %}";

/* ========= Helpers ========= */
function getCookie(name) {
  const v = `; ${document.cookie}`.split(`; ${name}=`);
  if (v.length === 2) return v.pop().split(';').shift();
}
const CSRF_TOKEN = getCookie('csrftoken');
const CURRENT_USER_ID = Number("{{ user.id|default_if_none:'0' }}");

/* ========= Endpoints ========= */
const API_LIST     = "{% url 'main:show_json' %}";
const API_CREATE   = "{% url 'main:add_products_entry_ajax' %}";
const API_DETAIL   = (id) => "{% url 'main:show_json_by_id' 0 %}".replace("0", id);
const API_UPDATE   = (id) => "{% url 'main:update_product_ajax' 0 %}".replace("0", id);
const API_DELETE   = (id) => "{% url 'main:delete_product_ajax' 0 %}".replace("0", id);

/* ========= UI Elements ========= */
const gridEl    = document.getElementById('grid');
const loadingEl = document.getElementById('loading');
const emptyEl   = document.getElementById('empty');
const errorEl   = document.getElementById('error');

const crudModal = document.getElementById('crudModal');
const crudContent = document.getElementById('crudModalContent');
const form = document.getElementById('productForm');
const btnSubmit = document.getElementById('submitProduct');

let MODE = 'create'; // 'create' | 'edit'
let EDIT_ID = null;

const deleteModal = document.getElementById('deleteModal');
const btnCancelDelete = document.getElementById('btnCancelDelete');
const btnConfirmDelete = document.getElementById('btnConfirmDelete');
let DELETE_ID = null;

/* ========= Toast ========= */
function toastSuccess(title, msg){ showToast(title, msg, 'success', 2500); }
function toastError(title, msg){ showToast(title, msg || 'Something went wrong', 'error', 3000); }

/* ========= State toggles ========= */
function showLoading(){ loadingEl?.classList.remove('hidden'); errorEl?.classList.add('hidden'); emptyEl?.classList.add('hidden'); }
function showError(msg){ if(errorEl){ errorEl.textContent = msg || 'Failed to load'; errorEl.classList.remove('hidden'); } loadingEl?.classList.add('hidden'); emptyEl?.classList.add('hidden'); }
function showEmpty(){ emptyEl?.classList.remove('hidden'); loadingEl?.classList.add('hidden'); errorEl?.classList.add('hidden'); gridEl.innerHTML=''; }
function showGrid(){ loadingEl?.classList.add('hidden'); errorEl?.classList.add('hidden'); emptyEl?.classList.add('hidden'); }

/* ========= Modal helpers ========= */
function showModal(){ crudModal.classList.remove('hidden'); setTimeout(()=>{ crudContent?.focus(); }, 0); }
function hideModal(){ crudModal.classList.add('hidden'); }

/* set form values */
function setFormValues(data = {}){
  form.name.value = data.name || '';
  form.description.value = data.description || '';
  form.category.value = data.category || '';
  form.price.value = data.price || '';
  form.size.value = data.size || '';
  form.color.value = data.color || '';
  form.thumbnail.value = data.thumbnail || '';
  form.is_featured.checked = !!data.is_featured;
}

/* ========= Render card ========= */
function cardHTML(p){
  const isOwner = (Number(p.user_id) === CURRENT_USER_ID);
  return `
<article class="card-float bg-white/90 border border-purple-100 rounded-xl shadow-sm hover:shadow-md transition p-3">
  <a href="/product/${p.id}/" class="block focus:outline-none focus:ring-2 focus:ring-purple-300 rounded-lg">
    <div class="relative w-full aspect-[4/3] overflow-hidden rounded-lg mb-3">
      ${p.thumbnail ? 
        `<img src="${p.thumbnail}" class="w-full h-full object-cover" alt="${(p.name||'Product').replace(/"/g,'&quot;')}">` :
        `<img src="${NO_IMAGE_URL}" class="w-full h-full object-contain p-6" alt="Product">`
      }
    </div>
    <h3 class="font-bold text-gray-900 mb-1 line-clamp-2">${p.name || '(No Name)'}</h3>
    <p class="text-gray-600 text-sm line-clamp-3">${(p.description || '').toString().slice(0,160)}</p>
  </a>

  ${isOwner ? `
  <div class="mt-3 flex justify-end gap-2">
    <button data-id="${p.id}" class="btn-edit px-3 py-1.5 text-xs border rounded-lg hover:bg-gray-50">Edit</button>
    <button data-id="${p.id}" class="btn-delete px-3 py-1.5 text-xs border border-red-200 text-red-600 rounded-lg hover:bg-red-50">Delete</button>
  </div>` : ``}
</article>`;
}

function renderGrid(list){
  if(!Array.isArray(list) || list.length === 0){
    showEmpty();
    return;
  }
  gridEl.innerHTML = list.map(cardHTML).join('');
  showGrid();
}

/* ========= URL & Params helpers ========= */
const qInput = document.getElementById('qInput');
const searchForm = document.getElementById('searchForm');

function parseQS(qs){
  const usp = new URLSearchParams(qs || window.location.search);
  const out = {};
  for(const [k,v] of usp.entries()) out[k]=v;
  return out;
}
function currentParams(){
  const base = parseQS();
  if(qInput) base.q = qInput.value.trim();
  return base;
}
function applyParamsToURL(params, replace=false){
  const usp = new URLSearchParams(params);
  const newUrl = `${window.location.pathname}?${usp.toString()}`;
  if(replace) history.replaceState(null,'',newUrl); else history.pushState(null,'',newUrl);
}

/* ========= Data loaders ========= */
async function fetchList(params = {}){
  showLoading();
  try{
    const usp = new URLSearchParams(params);
    const url = usp.toString() ? `${API_LIST}?${usp}` : API_LIST;
    const res = await fetch(url, { headers:{'Accept':'application/json'} });
    if(!res.ok) throw new Error('Failed to fetch');
    const data = await res.json();
    renderGrid(data);
  }catch(e){
    console.error(e);
    showError('Tidak bisa memuat produk');
  }
}

async function fetchDetail(id){
  const res = await fetch(API_DETAIL(id), { headers:{'Accept':'application/json'} });
  if(!res.ok) throw new Error('Not found');
  return await res.json();
}

/* ========= Actions ========= */
function setCreateMode(){
  MODE = 'create';
  EDIT_ID = null;
  document.querySelector('#crudModal h3').textContent = 'Create Product';
  document.querySelector('#crudModal p.text-sm')?.classList.remove('hidden');
  setFormValues({});
  showModal();
}
async function setEditMode(id){
  MODE = 'edit';
  EDIT_ID = id;
  document.querySelector('#crudModal h3').textContent = 'Edit Product';
  document.querySelector('#crudModal p.text-sm')?.classList.add('hidden');
  try{
    const p = await fetchDetail(id);
    setFormValues(p);
    showModal();
  }catch(e){
    toastError('Gagal', 'Tidak bisa memuat data produk.');
  }
}

/* CREATE / UPDATE submit */
btnSubmit.addEventListener('click', async function(e){
  e.preventDefault();
  const formData = new FormData(form);
  try{
    let url = API_CREATE;
    if(MODE === 'edit' && EDIT_ID) url = API_UPDATE(EDIT_ID);

    const res = await fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF_TOKEN },
      body: formData
    });
    if(!res.ok){
      let msg = 'Request failed';
      try { const j = await res.json(); msg = j.error || JSON.stringify(j); } catch(_){}
      throw new Error(msg);
    }
    hideModal();
    setFormValues({});
    await fetchList(currentParams());
    toastSuccess(MODE === 'edit' ? 'Updated' : 'Created',
                 MODE === 'edit' ? 'Produk berhasil diperbarui.' : 'Produk berhasil dibuat.');
  }catch(err){
    console.error(err);
    toastError('Gagal', MODE === 'edit' ? 'Gagal memperbarui produk.' : 'Gagal membuat produk.');
  }
});

/* DELETE flow (modal konfirmasi) */
function openDeleteModal(id){ DELETE_ID = id; deleteModal.classList.remove('hidden'); }
function closeDeleteModal(){ DELETE_ID = null; deleteModal.classList.add('hidden'); }
btnCancelDelete.addEventListener('click', closeDeleteModal);
btnConfirmDelete.addEventListener('click', async ()=>{
  if(!DELETE_ID) return;
  try{
    const res = await fetch(API_DELETE(DELETE_ID), {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF_TOKEN }
    });
    if(!res.ok) throw new Error('Delete failed');
    closeDeleteModal();
    await fetchList(currentParams());
    toastSuccess('Deleted', 'Produk berhasil dihapus.');
  }catch(e){
    console.error(e);
    toastError('Gagal', 'Tidak bisa menghapus produk.');
  }
});

/* Delegasi event untuk tombol Edit/Delete pada grid */
gridEl.addEventListener('click', (ev)=>{
  const editBtn = ev.target.closest('.btn-edit');
  const delBtn  = ev.target.closest('.btn-delete');
  if(editBtn){
    ev.preventDefault();
    const id = Number(editBtn.dataset.id);
    if(id) setEditMode(id);
  }else if(delBtn){
    ev.preventDefault();
    const id = Number(delBtn.dataset.id);
    if(id) openDeleteModal(id);
  }
});

/* Tombol create di header & empty */
const btnOpenCreate = document.getElementById('btnOpenCreate');
btnOpenCreate?.addEventListener('click', (e)=>{ e.preventDefault(); setCreateMode(); });
const btnOpenCreateEmpty = document.getElementById('btnOpenCreateEmpty');
btnOpenCreateEmpty?.addEventListener('click', (e)=>{ e.preventDefault(); setCreateMode(); });

/* Tombol Refresh */
const btnRefresh = document.getElementById('btnRefresh');
btnRefresh?.addEventListener('click', async ()=>{
  await fetchList(currentParams());
  toastSuccess('Refreshed', 'Daftar produk diperbarui.');
});

/* Close modal saat klik backdrop */
crudModal.addEventListener('click', (e)=>{ if(e.target === crudModal) hideModal(); });
deleteModal.addEventListener('click', (e)=>{ if(e.target === deleteModal) closeDeleteModal(); });

/* ESC to close modals */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    if(!crudModal.classList.contains('hidden')) hideModal();
    if(!deleteModal.classList.contains('hidden')) closeDeleteModal();
  }
});

/* Intercept Search form (AJAX) */
searchForm?.addEventListener('submit', (e)=>{
  e.preventDefault();
  const params = currentParams();
  applyParamsToURL(params, false);
  fetchList(params);
});

/* Init (ambil parameter URL awal) */
window.addEventListener('popstate', ()=> fetchList(currentParams()));
(function syncQ(){
  const qs = parseQS();
  if(qInput && typeof qs.q === 'string') qInput.value = qs.q;
})();
fetchList(currentParams());
</script>
{% endblock content %}

{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>BolaBale Store</title>
{% endblock meta %}

{% block content %}
  {% include 'navbar.html' %}

  {# ===== CSS kecil untuk modal flip (CSS-only) ===== #}
  <style>
    /* dasar modal */
    .bb-modal{ position:fixed; inset:0; display:none; }
    .bb-modal:target{ display:block; }
    .bb-overlay{ position:absolute; inset:0; background:rgba(0,0,0,.5); }

    /* container untuk memberi depth 3D */
    .bb-flip{ position:relative; z-index:1; perspective:1500px; }

    /* kartu yang nge-flip */
    .bb-card{
      position: relative;
      max-width: 56rem;
      width: calc(100% - 2rem);
      margin: 2.5rem auto;
      border-radius: 1rem;
      background: rgba(255,255,255,.9);
      -webkit-backdrop-filter: saturate(140%) blur(6px);
      backdrop-filter: saturate(140%) blur(6px);
      border: 1px solid #e9d5ff;
      box-shadow: 0 20px 40px -24px rgba(124,58,237,.35),
                  0 6px 16px -10px rgba(124,58,237,.18);
      padding: 1.5rem;

      /* efek flip */
      transform-style: preserve-3d;
      transform: rotateY(90deg);
      opacity: 0;
      transition: transform .6s ease, opacity .6s ease;
    }
    /* saat :target aktif -> kebuka */
    .bb-modal:target .bb-card{
      transform: rotateY(0deg);
      opacity: 1;
    }

    .bb-close{
      position:absolute; top:.5rem; right:.5rem;
      width:2rem; height:2rem; border-radius:9999px;
      background:#fff; display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(0,0,0,.08);
    }

    /* fallback clamp kalau plugin tailwind belum aktif */
    .line-clamp-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .line-clamp-3{ display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }

    @media (prefers-reduced-motion: reduce){
      .bb-card{ transition:none!important; transform:none!important; opacity:1!important; }
    }
  </style>

  <div class="bg-floating-blobs w-full pt-20 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

      {# ===================== HOME SECTION ===================== #}
      {% if is_home %}
      <section id="home" class="mb-12">
        <!-- Welcome -->
        <div class="flex items-start justify-between gap-4 mb-6">
          <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-1">
              Welcome, <span class="text-purple-600">{{ user.username }}</span>!
            </h1>
            <p class="text-gray-600">Your next winning goal starts with the perfect gear</p>
          </div>
          <div class="hidden sm:block text-sm text-gray-500">Last login: {{ last_login }}</div>
        </div>

        <!-- Search -->
        <form method="get" action="" class="mb-6">
          <div class="glass rounded-2xl border border-purple-100 p-3 shadow-card flex items-center gap-3">
            <svg class="w-5 h-5 text-purple-500" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21 21l-4.3-4.3m1.8-5.2a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input type="text" name="q" value="{{ query }}" placeholder="Search products..."
                   class="w-full bg-transparent focus:outline-none placeholder-gray-400">
            <button class="px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700">
              Search
            </button>
          </div>
        </form>

        <!-- Hero -->
        <div class="rounded-2xl overflow-hidden shadow-card mb-8"
             style="background:linear-gradient(135deg,#f5e8ff,#dbeafe 55%,#ffd1e6);">
          <div class="p-6 sm:p-8 flex flex-col sm:flex-row items-center gap-6">
            <div class="flex-1">
              <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900 mb-2">The Beautiful Game, Perfected</h2>
              <p class="text-gray-700 mb-4">Find your matchday edge here.</p>
              <a href="#all" class="px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700">Explore All Products →</a>
            </div>
            <img src="{% static 'image/no-name.JPG' %}" class="w-40 h-40 object-cover rounded-xl ring-4 ring-white/60 shadow-md" alt="promo">
          </div>
        </div>

        <!-- Most Popular -->
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-xl font-bold text-gray-900">Most Popular</h3>
          <a href="?filter=all" class="text-sm text-purple-600 hover:underline">See all</a>
        </div>

        {% if popular_list %}
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
            {% for product in popular_list %}
              {% include 'card_product.html' with product=product %}
            {% endfor %}
          </div>
        {% else %}
          <div class="glass rounded-2xl border border-purple-100 p-6 shadow-card text-gray-600">
            No popular products yet.
          </div>
        {% endif %}
      </section>
      {% endif %}
      {# =================== END HOME =================== #}

      <!-- ===================== ALL PRODUCTS ===================== -->
      <section id="all">
        <div class="mb-6 flex items-center justify-between">
          <h3 class="text-xl font-bold text-gray-900">
            {% if query %}Search Results{% elif filter_type == 'my' %}My Products{% elif selected_category %}Category: {{ selected_category }}{% else %}All Products{% endif %}
          </h3>

          {% if user.is_authenticated %}
            <a href="{% url 'main:create_product' %}" class="px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700">
              + Create Product
            </a>
          {% endif %}
        </div>

        {% if not product_list %}
          <div class="glass rounded-2xl border border-purple-100 p-12 text-center shadow-card">
            <img src="{% static 'image/no-name.JPG' %}" alt="No product" class="w-32 h-32 mx-auto mb-5 object-contain">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">No Products yet</h3>
            <p class="text-gray-500 mb-6">Be the first to add a product to the shop.</p>
            {% if user.is_authenticated %}
              <a href="{% url 'main:create_product' %}" class="px-5 py-3 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700">
                Create Product
              </a>
            {% else %}
              <a href="{% url 'main:login_user' %}" class="px-5 py-3 rounded-lg bg-gray-900 text-white font-semibold hover:opacity-90">
                Login to Create
              </a>
            {% endif %}
          </div>
        {% else %}
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5">
            {% for product in product_list %}
              {% include 'card_product.html' with product=product %}
            {% endfor %}
          </div>
        {% endif %}
      </section>

      {# ============== MODALS (Detail & Edit) – FLIP CSS-ONLY ============== #}
      {% for p in product_list %}
        <!-- DETAIL -->
        <div id="p{{ p.id }}-detail" class="bb-modal">
          <a href="#" class="bb-overlay" aria-label="Close"></a>
          <div class="bb-flip">
            <div class="bb-card p-6 sm:p-8">
              <a href="#" class="bb-close" aria-label="Close">✕</a>

              <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-3">
                  <div class="rounded-xl overflow-hidden border">
                    {% if p.thumbnail %}
                      <img src="{{ p.thumbnail }}" alt="{{ p.name }}" class="w-full h-64 object-cover">
                    {% else %}
                      <img src="{% static 'image/no-name.JPG' %}" alt="Product" class="w-full h-64 object-contain p-6">
                    {% endif %}
                  </div>
                  <div class="text-sm text-gray-600">
                    <div><span class="font-medium">Author:</span> {{ p.user.get_full_name|default:p.user.username }}</div>
                    <div><span class="font-medium">Views:</span> {{ p.views }}</div>
                    <div><span class="font-medium">Created:</span> {{ p.created_at|date:"M j, Y" }}</div>
                  </div>
                </div>

                <div>
                  <h3 class="text-2xl font-bold text-gray-900 mb-2">{{ p.name }}</h3>
                  <p class="text-gray-700 leading-relaxed mb-4">{{ p.description|default:"—" }}</p>

                  <div class="flex items-center gap-2 text-sm text-gray-700 mb-4">
                    <span class="px-2 py-0.5 rounded bg-gray-100">{{ p.size|default:"-" }}</span>
                    <span class="px-2 py-0.5 rounded bg-gray-100">{{ p.category|default:"Uncategorized" }}</span>
                  </div>

                  {% if p.color_list %}
                    <div class="mt-2 flex items-center gap-2">
                      {% for c in p.color_list %}
                        {% if c %}<span class="w-4 h-4 rounded-full border" style="background: {{ c }}"></span>{% endif %}
                      {% endfor %}
                    </div>
                  {% endif %}

                  <div class="mt-6 flex items-center gap-3">
                    <a href="#" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50">Close</a>
                    {% if p.can_edit %}
                      <a href="#p{{ p.id }}-edit" class="px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700">Edit</a>
                    {% endif %}
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        {% if p.can_edit %}
        <!-- EDIT -->
        <div id="p{{ p.id }}-edit" class="bb-modal">
          {# overlay balik ke detail supaya transisi tetap flip enak #}
          <a href="#p{{ p.id }}-detail" class="bb-overlay" aria-label="Back"></a>
          <div class="bb-flip">
            <div class="bb-card p-6 sm:p-8">
              <a href="#p{{ p.id }}-detail" class="bb-close" aria-label="Back">✕</a>

              <div class="grid md:grid-cols-2 gap-6">
                <!-- Preview -->
                <div class="space-y-3">
                  <div class="rounded-xl overflow-hidden border">
                    {% if p.thumbnail %}
                      <img src="{{ p.thumbnail }}" alt="{{ p.name }}" class="w-full h-56 object-cover">
                    {% else %}
                      <img src="{% static 'image/no-name.JPG' %}" alt="Product" class="w-full h-56 object-contain p-6">
                    {% endif %}
                  </div>
                  <div class="text-sm text-gray-600">
                    <div><span class="font-medium">Author:</span> {{ p.user.get_full_name|default:p.user.username }}</div>
                    <div><span class="font-medium">Views:</span> {{ p.views }}</div>
                    <div><span class="font-medium">Created:</span> {{ p.created_at|date:"M j, Y" }}</div>
                  </div>
                </div>

                <!-- Form -->
                <div class="form-style">
                  <h3 class="text-xl font-bold text-gray-900 mb-3">Edit Product</h3>
                  <form method="post" action="{% url 'main:edit_product' p.id %}" enctype="multipart/form-data" class="space-y-4">
                    {% csrf_token %}
                    {{ p.edit_form.as_p }}

                    <div class="flex justify-end gap-3 pt-3">
                      <a href="#p{{ p.id }}-detail" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50">Back</a>
                      <button type="submit" class="px-5 py-2 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700">
                        Save Changes
                      </button>
                    </div>
                  </form>
                </div>
              </div>

            </div>
          </div>
        </div>
        {% endif %}
      {% endfor %}

      {# opsional: tekan ESC untuk nutup #}
      <script>
        (function(){
          const closeHash = () => {
            if (location.hash) history.pushState("", document.title, window.location.pathname + window.location.search);
          };
          window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeHash(); });
        })();
      </script>

    </div>
  </div>
{% endblock content %}
